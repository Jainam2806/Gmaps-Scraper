from flask import Flask, render_template, request, send_file
from scraper import *
import csv
import io
import os

app = Flask(__name__)
results = {}
# results = {1: {'shop_name': 'World Of Mobile', 'shop_address': 'Cell phone store · Maruti Tower, UL 4,5, cross road, nr. shivrajani', 'shop_phone': 9173923453}, 2: {'shop_name': 'Om Bhavani Mobile Shop', 'shop_address': 'Cell phone store · A-48, Basement, Popular Plaza, Someshwar Complex -1, 132 Feet Ring Road, Near Sun Photo, Shyamal X Road, Satellite, Shyamal', 'shop_phone': 8000001550}, 3: {'shop_name': 'Mobile Gallery Brand Store', 'shop_address': 'Cell phone store · soc, 20 UGF,Akash Tower, Above IOB Bank, Judges Bunglow Rd, opp. Premchand nagar', 'shop_phone': 9825529566}, 4: {'shop_name': 'The Michael Mobile Store', 'shop_address': 'Cell phone store · 14 goyal plaza complex, opp. gwalia sweat mart, near Mansi Cross Road', 'shop_phone': 8866440201}, 5: {'shop_name': 'Royal Wireless', 'shop_address': 'Cell phone store · Ul 5, Maruti Tower, Shivranjani Flyover', 'shop_phone': 9898756565}, 6: {'shop_name': 'JAY AMBE MOBILE WORLD Best mobile in Shyamal Ahmedabad', 'shop_address': 'Cell phone store · FF2, Sagar Complex, 132 Feet Ring Rd', 'shop_phone': 7586498574}, 7: {'shop_name': 'Jay Bhole Mobile And Accessories Hub | Best Mobile Shop in Ahmedabad', 'shop_address': 'Cell phone store · 26, Janpath Shopping Center, behind SHRI SAHAJANAND ARTS & COMMERCE COLLEGE', 'shop_phone': 9714840698}, 8: {'shop_name': 'UK I World Second Hand Phone in ahmedabad', 'shop_address': 'Cell phone store · Titanium City Centre Mall, 14-15, 100 Feet Anand Nagar Rd', 'shop_phone': 9537501912}, 9: {'shop_name': 'Jay Bhole Mobile Shop And Computer Accessories', 'shop_address': 'Cell phone store · Shop No. 19, Ground Floor, Akshardham Complex, Judges Bungalow, Premchand Nagar Rd', 'shop_phone': 7990300717}, 10: {'shop_name': 'Foram mobile', 'shop_address': 'Cell phone store · 123-124 vrundavan shopping centre, 132 Feet Ring Rd, opposite hyundai showroom', 'shop_phone': 9173802050}, 11: {'shop_name': 'ARIHANT MOBILE', 'shop_address': 'Cell phone store · Shop No.9, Earth Complex, 100 Feet Anand Nagar Rd, nr. Seema Hall', 'shop_phone': 9824256507}, 12: {'shop_name': 'Exchange Mobi', 'shop_address': 'Cell phone store · G-2 , Manas Complex Satellite Main Road, Jodhpur Cross Rd', 'shop_phone': 7377777758}, 13: {'shop_name': 'Prince Communication', 'shop_address': 'Cell phone store · 21-22 Ground Floor Mansi Complex Near Swaminagar Mandir Vastrapura', 'shop_phone': 9825238888}, 14: {'shop_name': 'The Mobile Duniya', 'shop_address': 'Cell phone store · UL/6, Maruti Tower, Near Shivranjoni Cross Road Satellite, Surendra Mangaldas Road, Bimanagar, Ambavadi,', 'shop_phone': 7926730144}, 15: {'shop_name': 'Bapu Mobile Store', 'shop_address': 'Cell phone store · F-3, Shivani Apartments, Dr Sanjay Gandhi, opp. Jay Shiva Tower, nr. Azad Soc', 'shop_phone': 9898001116}, 16: {'shop_name': 'Fonebook Shivranajani', 'shop_address': 'Cell phone store · UL 02, Maruti Tower, Shivranjani Cross Rd', 'shop_phone': 8460143712}, 17: {'shop_name': 'Maruti Communication', 'shop_address': 'Cell phone store · Shop 9, 6, Prernatirth Derasar Rd', 'shop_phone': 9974284853}, 18: {'shop_name': 'Mobile Cafe', 'shop_address': 'Cell phone store · G-5, Shakti Square Complex, near Mahakal pakodi', 'shop_phone': None}, 19: {'shop_name': 'Zoop Mobile', 'shop_address': 'Cell phone store · 1st Floor, Goyal Plaza, F-18, Nyay Marg, opposite Goyal Park, near Mansi Circle', 'shop_phone': 9687025550}, 20: {'shop_name': 'SHYAM MOBILE', 'shop_address': 'Cell phone store · Nandanvan 4, J-16, opposite Aangan Party Plot', 'shop_phone': 9998169460}, 21: {'shop_name': 'Maruti Communication', 'shop_address': 'Cell phone store · 55, Springfiled society, Opp Premchandnagar, Judges Bunglow Rd, opp. Laxmi Ganthiya', 'shop_phone': 9879146230}, 22: {'shop_name': 'Kabir World', 'shop_address': 'Cell phone store · Maruti Tower, First Floor, Shivranjani Cross Rd', 'shop_phone': None}, 23: {'shop_name': 'Check Point', 'shop_address': 'Cell phone store · Shop Number 4, Sun Rise Mall, Nyay Marg, near Mansi Circle', 'shop_phone': 7940325969}, 24: {'shop_name': 'Shree Raj Mobile Store', 'shop_address': 'Cell phone store · 25, Bhudarpura Rd', 'shop_phone': 7383306090}, 25: {'shop_name': 'Poojara Telecom, Satellite - Ahmedabad', 'shop_address': 'Cell phone store · 108-109, Someshwara-ll, Road, opp. Star Bazaar, nr. Jodhpur Char Rasta', 'shop_phone': 9737406506}, 26: {'shop_name': 'VIVO STORE (Royal Wirless, Ahmedabad)', 'shop_address': 'Cell phone store · Near, BRTS BUS STAND, UL/7 MARUTI TOWER, Shivranjani, SHIVRANJANI, Shivranjani Cross Rd', 'shop_phone': 9913922236}, 27: {'shop_name': 'Shree ram Mobile & Accessories', 'shop_address': 'Cell phone store · 3, brts stand, Maruti Tower, opposite shivrangini', 'shop_phone': None}, 28: {'shop_name': 'Super Service used computers and mobile shop', 'shop_address': 'Cell phone store · 2GCV+W6V', 'shop_phone': None}, 29: {'shop_name': 'Shree Sangam Mobile Store', 'shop_address': 'Cell phone store · 8, Shwetang Complex, Opp. M. G. Party Plot, Gam, Satellite', 'shop_phone': 8128448985}, 30: {'shop_name': 'International Communication Mobile Shop', 'shop_address': 'Cell phone store · SHO NO 7 , 8, Goyal Terrace Comlex, Judges Bungalow Rd', 'shop_phone': 9697989222}, 31: {'shop_name': 'RAJDHANI MOBILE', 'shop_address': 'Mobile phone repair shop · SHOP NO 64, BLOCK i, TITANIUM CITY CENTRE MALL IN LANE OF IDEA SHOWROOM, SATELITE', 'shop_phone': None}, 32: {'shop_name': 'Karan Mobile Shop', 'shop_address': 'Cell phone store · 2G6M+9X5, Rajiv Nagar Rd', 'shop_phone': 9375755512}, 33: {'shop_name': 'Aman Mobile Store -JioMart Digital Partner', 'shop_address': 'Electronics store · Ground 18/B, Lake Ahmadabad, Himalaya Arcade B', 'shop_phone': 9825888818}, 34: {'shop_name': 'MMB Luxury Mobile Shop - Apple Store / Mobile Accessories in Gujarat', 'shop_address': 'Cell phone store · 39/40, Rudra Square, opp. Hotel Pride', 'shop_phone': 9925399251}, 35: {'shop_name': 'Krishna Mobile Shop', 'shop_address': 'Cell phone store · 7, Karnavati Complex, Opposite Trupti Bakery, Near, Jodhpur Village Road, Jodhpur Gam Rd', 'shop_phone': 9898981923}, 36: {'shop_name': 'Sigma Communication', 'shop_address': 'Cell phone store · 8', 'shop_phone': 9824688766}, 37: {'shop_name': 'Satnam Electronics', 'shop_address': 'Cell phone store · 2GP9+86J', 'shop_phone': 9825047722}, 38: {'shop_name': 'MI Store', 'shop_address': 'Cell phone store · BRTS Bus Stop, ul-5 maruti tower opp shivranjani, Shivranjani Cross Rd', 'shop_phone': 9898756565}, 39: {'shop_name': 'Kore Mobile', 'shop_address': 'Cell phone store · UL - 4,Maruti Tower, Near Shivranjani Cross Road, Surendra Mangaldas Rd', 'shop_phone': 8511177658}, 40: {'shop_name': 'Gadgets The Mobile shop', 'shop_address': 'Cell phone store · 13 Sarvamangal Jivraj Mehta Hospital', 'shop_phone': 9998762990}, 41: {'shop_name': 'Shreeji Mobile Shop', 'shop_address': 'Cell phone store · Shree Vraj Bhumi Complex, Behind Falgun Society, Jodhpur Gam Rd, opp. Riddhi Tower', 'shop_phone': 9574121410}, 42: {'shop_name': 'Mobile exchange best mobile shop', 'shop_address': 'Cell phone store · First Floor 9, Chinmay Crystal Tower, lake, opp. Vastrapur', 'shop_phone': 8866648948}, 43: {'shop_name': 'Kamal Times & Electronics', 'shop_address': 'Cell phone store · 4, Anandvihar Apartment, Himatlal Park, Azad Society Main Rd', 'shop_phone': 9898493105}, 44: {'shop_name': 'Apple n Berry Shop', 'shop_address': 'Cell phone store · 31 Manas Complex, opposite Star Bazaar', 'shop_phone': 9974444441}, 45: {'shop_name': 'Maya Mobile Shop', 'shop_address': 'Cell phone store · 1, Krishna Shopping Centre Opp. Bank of India Near Gurukrupa School, CTM Cross Road', 'shop_phone': 9898986260}, 46: {'shop_name': 'Vision mobile Bodakdev', 'shop_address': 'Cell phone store · 31 , 1st floor, RUDRA SQUARE APARTMENT, Judges Bungalow Cross Rd, opp. kalupur co-operative bank', 'shop_phone': 8989809797}, 47: {'shop_name': 'Mobile galaxy, Samsung Authorized Store', 'shop_address': 'Cell phone store · lake, Shop No:G.F 8,Sardar Center,Nr. Havmor Ice Cream, Sargam Marg, opp. Vastrapur', 'shop_phone': 7940092345}, 48: {'shop_name': 'SHREE UMIYA MOBILE SALES AND SERVICES', 'shop_address': 'Cell phone store · Shree Umiya Mobile shop no. 26, G.F. PALAK-2, OPPOSITE SHREEJI ENCLAVE, near AMC zoals office', 'shop_phone': None}, 49: {'shop_name': 'SK Mobile Store', 'shop_address': 'Cell phone store · NR KALYAN JEWELLERS,BHUDARPURA ROAD, AMBAWADI AHMEDABAD 380006', 'shop_phone': 7698284230}, 50: {'shop_name': 'parshwa mobile store', 'shop_address': 'Cell phone store · bhagvatinagar shoping cannte,bhagvatinagar,nr. crosing, 2', 'shop_phone': 9898699595}}
query = ''
@app.route("/")
def show_page():
    return render_template('home.html')

@app.route("/show_data", methods=['POST'])
def show_results():
    global query
    global results
    query = request.form['query']
    results = main(query)
    return render_template('show_data.html', results=results)

@app.route('/download', methods=['POST'])
def download():
    global results
    global query
    fieldnames = ['Sr.no', 'shop_name', 'shop_address', 'shop_phone', 'whatsapp_link']
    csv_filename = query+'.csv'
    
    with open(csv_filename, 'w', encoding='utf-8', newline='') as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()
        for sr_no, shop_data in results.items():
            if shop_data['shop_phone'] is not None:
                whatsapp_link = f"https://wa.me/91{shop_data['shop_phone']}"
                link_formula = f'=HYPERLINK("{whatsapp_link}", "WhatsApp")'
            else :
                whatsapp_link = ""
            row = {'Sr.no': sr_no, 'whatsapp_link': whatsapp_link}
            row.update(shop_data)
            writer.writerow(row)
            
    return_data = io.BytesIO()
    with open(csv_filename, 'rb') as fo:
        return_data.write(fo.read())
    os.remove(csv_filename)
    return_data.seek(0)
    
    return send_file(return_data, mimetype='text/csv',as_attachment=True,download_name=csv_filename)

if __name__ == "__main__":
    app.run(debug=True, host='0.0.0.0' ,port=8000)